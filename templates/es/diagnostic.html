{% extends "base.html" %}

{% block title %}Diagnostico Inicial{% endblock %}

{% block head %}
<style>
    .diagnostic-card {
        border-left: 4px solid;
        transition: all 0.3s;
    }
    .diagnostic-card:hover {
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    .skill-literacy { border-color: #4CAF50; }
    .skill-numeracy { border-color: #2196F3; }
    .skill-digital { border-color: #9C27B0; }
    .skill-citizenship { border-color: #FF9800; }
    .question-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
    }
    .question-item:hover {
        background: #e9ecef;
    }
    .progress-ring {
        width: 80px;
        height: 80px;
    }
    .test-badge {
        position: absolute;
        top: 10px;
        right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('landing', lang=lang) }}">Proyecto</a></li>
                <li class="breadcrumb-item"><span class="badge bg-warning text-dark">WP3</span> Pilotos</li>
                <li class="breadcrumb-item active">Diagnostico Inicial</li>
            </ol>
        </nav>
        <h1><i class="bi bi-clipboard2-pulse text-info"></i> Diagnostico Inicial</h1>
        <p class="text-muted lead">
            Cuestionarios y pruebas diagnosticas para identificar necesidades, mapear fortalezas y debilidades,
            e iniciar el Itinerario de Aprendizaje Personalizado (PLP).
        </p>
    </div>
</div>

<!-- Info Alert -->
<div class="alert alert-info mb-4">
    <div class="row align-items-center">
        <div class="col-auto">
            <i class="bi bi-info-circle fs-3"></i>
        </div>
        <div class="col">
            <strong>Objetivo del diagnostico:</strong> Identificar el nivel inicial del estudiante en cada competencia
            para disenar un itinerario personalizado. Los resultados alimentan el sistema de IA para recomendar
            el punto de entrada optimo en cada rama del arbol de aprendizaje.
        </div>
    </div>
</div>

<!-- Student Selection -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Seleccionar Estudiante</h5>
            </div>
            <div class="card-body">
                <select class="form-select" id="student-select">
                    <option value="">-- Seleccionar estudiante --</option>
                    {% for student in students %}
                    <option value="{{ student.id }}">{{ student.name }} ({{ student.demographics.education_stage.name }})</option>
                    {% endfor %}
                </select>
                <div id="student-info" class="mt-3" style="display: none;">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Edad</small>
                            <p class="mb-0 fw-bold" id="student-age">-</p>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Nivel</small>
                            <p class="mb-0 fw-bold" id="student-level">-</p>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Comp. Digital</small>
                            <p class="mb-0 fw-bold" id="student-digital">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-light">
            <div class="card-body">
                <h6><i class="bi bi-lightbulb text-warning me-2"></i>Tipos de evaluacion diagnostica</h6>
                <ul class="mb-0 small">
                    <li><strong>Lectura critica:</strong> Comprension de textos breves</li>
                    <li><strong>Interpretacion digital:</strong> Navegacion y evaluacion de informacion en linea</li>
                    <li><strong>Comprension de datos:</strong> Graficos, porcentajes, estadisticas simples</li>
                    <li><strong>Actitudes civicas:</strong> Posicionamiento sobre cuestiones civicas</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Diagnostic Tests by Skill -->
<div class="row g-4">
    <!-- Digital Skills -->
    <div class="col-md-6">
        <div class="card h-100 diagnostic-card skill-digital position-relative">
            <span class="badge bg-purple test-badge" style="background: #9C27B0;">Principal</span>
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-laptop me-2" style="color: #9C27B0;"></i>Competencia Digital</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Evalua la capacidad de usar tecnologias digitales de forma segura, critica y responsable.</p>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>D1. Navegacion y busqueda</strong>
                            <p class="mb-0 small text-muted">Encontrar y evaluar informacion en linea</p>
                        </div>
                        <span class="badge bg-secondary">5 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>D2. Comunicacion digital</strong>
                            <p class="mb-0 small text-muted">Interaccion y colaboracion en entornos digitales</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>D3. Seguridad digital</strong>
                            <p class="mb-0 small text-muted">Proteccion de datos y privacidad</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <button class="btn btn-outline-primary w-100 mt-3" onclick="startDiagnostic('digital')">
                    <i class="bi bi-play-circle me-2"></i>Iniciar Diagnostico Digital
                </button>
            </div>
        </div>
    </div>

    <!-- Citizenship -->
    <div class="col-md-6">
        <div class="card h-100 diagnostic-card skill-citizenship position-relative">
            <span class="badge bg-warning text-dark test-badge">Principal</span>
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-flag me-2" style="color: #FF9800;"></i>Competencia Ciudadana</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Evalua los conocimientos sobre democracia, derechos y participacion civica.</p>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>C1. Valores democraticos</strong>
                            <p class="mb-0 small text-muted">Conocimiento de derechos fundamentales</p>
                        </div>
                        <span class="badge bg-secondary">5 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>C2. Alfabetizacion Mediatica</strong>
                            <p class="mb-0 small text-muted">Analisis critico de medios y desinformacion</p>
                        </div>
                        <span class="badge bg-secondary">6 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>C3. Sostenibilidad</strong>
                            <p class="mb-0 small text-muted">Cambio climatico y responsabilidad medioambiental</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <button class="btn btn-outline-warning w-100 mt-3" onclick="startDiagnostic('citizenship')">
                    <i class="bi bi-play-circle me-2"></i>Iniciar Diagnostico de Ciudadania
                </button>
            </div>
        </div>
    </div>

    <!-- Literacy -->
    <div class="col-md-6">
        <div class="card h-100 diagnostic-card skill-literacy position-relative">
            <span class="badge bg-success test-badge">Habilitadora</span>
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-book me-2" style="color: #4CAF50;"></i>Competencia Lectora</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Evalua la comprension lectora como competencia habilitadora para el aprendizaje digital y ciudadano.</p>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>L1. Comprension literal</strong>
                            <p class="mb-0 small text-muted">Identificacion de informacion explicita</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>L2. Comprension inferencial</strong>
                            <p class="mb-0 small text-muted">Deduccion de significados implicitos</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>L3. Lectura critica</strong>
                            <p class="mb-0 small text-muted">Evaluar y cuestionar textos</p>
                        </div>
                        <span class="badge bg-secondary">5 items</span>
                    </div>
                </div>

                <button class="btn btn-outline-success w-100 mt-3" onclick="startDiagnostic('literacy')">
                    <i class="bi bi-play-circle me-2"></i>Iniciar Diagnostico de Lectoescritura
                </button>
            </div>
        </div>
    </div>

    <!-- Numeracy -->
    <div class="col-md-6">
        <div class="card h-100 diagnostic-card skill-numeracy position-relative">
            <span class="badge bg-primary test-badge">Habilitadora</span>
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-calculator me-2" style="color: #2196F3;"></i>Competencia Numerica</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Evalua el razonamiento numerico como competencia habilitadora para interpretar datos y estadisticas.</p>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>N1. Interpretacion de datos</strong>
                            <p class="mb-0 small text-muted">Lectura de graficos y tablas</p>
                        </div>
                        <span class="badge bg-secondary">5 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>N2. Porcentajes y proporciones</strong>
                            <p class="mb-0 small text-muted">Calculo e interpretacion</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <div class="question-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>N3. Razonamiento logico</strong>
                            <p class="mb-0 small text-muted">Patrones y secuencias</p>
                        </div>
                        <span class="badge bg-secondary">4 items</span>
                    </div>
                </div>

                <button class="btn btn-outline-primary w-100 mt-3" onclick="startDiagnostic('numeracy')">
                    <i class="bi bi-play-circle me-2"></i>Iniciar Diagnostico de Calculo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Complete Diagnostic Button -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-primary text-white">
            <div class="card-body text-center py-4">
                <h4><i class="bi bi-lightning-charge me-2"></i>Diagnostico Completo</h4>
                <p class="mb-3">Realiza el diagnostico de las 4 competencias para obtener un perfil completo y recomendaciones de itinerario personalizadas.</p>
                <button class="btn btn-light btn-lg" onclick="startFullDiagnostic()">
                    <i class="bi bi-play-fill me-2"></i>Iniciar Diagnostico Completo (aprox. 25 min)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Diagnostic -->
<div class="modal fade" id="diagnosticModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clipboard2-check me-2"></i>Prueba Diagnostica</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="diagnostic-content">
                    <!-- Dynamic content loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="submit-diagnostic">Enviar Respuestas</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const studentSelect = document.getElementById('student-select');
const studentInfo = document.getElementById('student-info');

studentSelect.addEventListener('change', async function() {
    if (this.value) {
        const response = await fetch(`/api/students/${this.value}`);
        const student = await response.json();

        document.getElementById('student-age').textContent = student.demographics.age + ' anos';
        document.getElementById('student-level').textContent = student.demographics.education_stage;
        document.getElementById('student-digital').textContent = Math.round(student.demographics.digital_competence_score) + '%';
        studentInfo.style.display = 'block';
    } else {
        studentInfo.style.display = 'none';
    }
});

function startDiagnostic(skill) {
    if (!studentSelect.value) {
        alert('Por favor, selecciona un estudiante primero.');
        return;
    }

    const skillNames = {
        'digital': 'Competencia Digital',
        'citizenship': 'Competencia Ciudadana',
        'literacy': 'Competencia Lectora',
        'numeracy': 'Competencia Numerica'
    };

    document.getElementById('diagnostic-content').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <h5>Cargando prueba de ${skillNames[skill]}...</h5>
            <p class="text-muted">El diagnostico contendra preguntas adaptadas al nivel del estudiante.</p>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('diagnosticModal'));
    modal.show();

    // Simulate loading diagnostic questions
    setTimeout(() => {
        document.getElementById('diagnostic-content').innerHTML = generateDiagnosticQuestions(skill);
    }, 1500);
}

function startFullDiagnostic() {
    if (!studentSelect.value) {
        alert('Por favor, selecciona un estudiante primero.');
        return;
    }
    alert('Iniciando diagnostico completo de las 4 competencias...');
}

function generateDiagnosticQuestions(skill) {
    const questions = {
        'digital': [
            {q: 'Al buscar informacion en linea, cual es la mejor forma de verificar su fiabilidad?', options: ['Confiar en el primer resultado', 'Verificar en multiples fuentes', 'Solo usar Wikipedia', 'Preguntar a amigos']},
            {q: 'Que informacion NO deberias compartir en redes sociales publicas?', options: ['Tu musica favorita', 'Tu direccion de casa', 'Tus peliculas favoritas', 'Tu equipo deportivo']},
            {q: 'Que es el phishing?', options: ['Un tipo de red social', 'Un intento de robar datos personales', 'Un navegador web', 'Un tipo de archivo']}
        ],
        'citizenship': [
            {q: 'Cual de estos es un derecho fundamental reconocido por la UE?', options: ['Tener un coche', 'La libertad de expresion', 'Ganar la loteria', 'Tener una mascota']},
            {q: 'Como puedes identificar noticias falsas?', options: ['Si tiene muchos likes', 'Verificando la fuente y la fecha', 'Si la comparte un famoso', 'Si tiene fotos']},
            {q: 'Que son los ODS?', options: ['Objetivos de Desarrollo Sostenible', 'Organizaciones de Datos Seguros', 'Ordenes Digitales de Servicio', 'Opciones de Distribucion Social']}
        ],
        'literacy': [
            {q: 'Lee el siguiente parrafo y responde: "El cambio climatico afecta a todos los ecosistemas..." Cual es la idea principal?', options: ['Los ecosistemas son importantes', 'El cambio climatico tiene impacto global', 'El clima siempre cambia', 'Los animales migran']},
            {q: 'Que significa "interpretar" un texto?', options: ['Leerlo en voz alta', 'Comprender su significado profundo', 'Memorizarlo', 'Traducirlo']},
            {q: 'En un texto argumentativo, que es una falacia?', options: ['Una verdad absoluta', 'Un razonamiento erroneo', 'Un dato estadistico', 'Una conclusion']}
        ],
        'numeracy': [
            {q: 'Si un grafico muestra que el 40% de los estudiantes prefiere las matematicas, y hay 200 estudiantes, cuantos prefieren las matematicas?', options: ['40', '80', '120', '160']},
            {q: 'Que tipo de grafico es mejor para mostrar proporciones de un total?', options: ['Grafico de lineas', 'Grafico circular', 'Grafico de barras', 'Histograma']},
            {q: 'Si los datos muestran: 5, 7, 8, 8, 12, cual es la mediana?', options: ['5', '7', '8', '12']}
        ]
    };

    const skillQuestions = questions[skill] || [];
    let html = `<form id="diagnostic-form">`;

    skillQuestions.forEach((item, idx) => {
        html += `
            <div class="mb-4">
                <p class="fw-bold">${idx + 1}. ${item.q}</p>
                ${item.options.map((opt, i) => `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${idx}" id="q${idx}_${i}" value="${i}">
                        <label class="form-check-label" for="q${idx}_${i}">${opt}</label>
                    </div>
                `).join('')}
            </div>
        `;
    });

    html += `</form>`;
    return html;
}
</script>
{% endblock %}
